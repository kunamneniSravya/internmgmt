package com.finalproject.internMgmtSystem.service;

import com.finalproject.internMgmtSystem.dto.FeedbackDto;
import com.finalproject.internMgmtSystem.dto.RegisterUserDto;
import com.finalproject.internMgmtSystem.exception.ResourceNotFoundException;
import com.finalproject.internMgmtSystem.exception.UserAlreadyExistsException;
import com.finalproject.internMgmtSystem.model.*;
import com.finalproject.internMgmtSystem.repository.*;

import org.junit.jupiter.api.*;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.ValueSource;
import org.mockito.*;

import java.sql.Date;
import java.sql.Timestamp;
import java.util.*;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

class UserServiceTest {

    @Mock
    private UserDao userDao;

    @Mock
    private TaskDao taskDao;

    @Mock
    private PerformanceDao performanceDao;

    @Mock
    private StipendDao stipendDao;

    @Mock
    private BatchDao batchDao;

    @Mock
    private FeedbackDao feedbackDao;

    @Mock
    private AttendanceDao attendanceDao;

    @Mock
    private org.springframework.security.crypto.password.PasswordEncoder passwordEncoder;

    @InjectMocks
    private UserService userService;

    private RegisterUserDto registerDto;
    private User user;
    private InternshipBatch batch;
    private Task task;
    private Performance performance;
    private Stipend stipend;
    private Attendance attendance;

    @BeforeEach
    void setup() {
        MockitoAnnotations.openMocks(this);

        registerDto = new RegisterUserDto();
        registerDto.setUserName("Sravya");
        registerDto.setEmail("sravya@gmail.com");
        registerDto.setPassword("pass123");
        registerDto.setDob(Date.valueOf("2004-01-01"));
        registerDto.setContactNo("1234567890");
        registerDto.setAddress("Hyderabad");
        registerDto.setCollegeName("Vel Tech");
        registerDto.setGrade("A");
        registerDto.setMajor("AIML");
        registerDto.setTeam("Team A");
        registerDto.setBatchCode(1L);
        registerDto.setStartDate(Date.valueOf("2025-01-01"));
        registerDto.setEndDate(Date.valueOf("2025-06-01"));
        registerDto.setGraduatingYear(2025);
        registerDto.setResume("resume.pdf");
        registerDto.setProfilePic("pic.png");

        batch = new InternshipBatch();
        batch.setBatchCode(1L);
        batch.setAvailableSeats(5);

        user = new User();
        user.setUserId(1L);
        user.setUserName("Sravya");
        user.setEmail("sravya@gmail.com");

        task = new Task();
        task.setId(1L);
        task.setUserId(1L);

        performance = new Performance();
        performance.setId(1L);
        performance.setUserId(1L);

        stipend = new Stipend();
        stipend.setId(1L);
        stipend.setUserId(1L);

        attendance = new Attendance();
        attendance.setAttendanceId(1L);
        attendance.setUserId(1L);
    }

    // -----------------------------------------------------------------------------------------
    // REGISTER USER
    // -----------------------------------------------------------------------------------------
    @Test
    void testRegisterUser_Success() {

        when(userDao.findByEmail("sravya@gmail.com")).thenReturn(null);
        when(batchDao.findByBatchCode(1L)).thenReturn(batch);
        when(passwordEncoder.encode(anyString())).thenReturn("encoded_pwd");
        when(userDao.save(any())).thenReturn(user);

        User saved = userService.registerUser(registerDto);

        assertNotNull(saved);
        assertEquals("Sravya", saved.getUserName());

        verify(batchDao, times(1)).decrementAvailableSeats(1L);
    }

    @Test
    void testRegisterUser_EmailExists() {

        when(userDao.findByEmail("sravya@gmail.com")).thenReturn(user);

        assertThrows(UserAlreadyExistsException.class,
                () -> userService.registerUser(registerDto));
    }

    @Test
    void testRegisterUser_BatchNotFound() {

        when(userDao.findByEmail(anyString())).thenReturn(null);
        when(batchDao.findByBatchCode(1L)).thenReturn(null);

        assertThrows(ResourceNotFoundException.class,
                () -> userService.registerUser(registerDto));
    }

    @Test
    void testRegisterUser_NoSeatsAvailable() {

        batch.setAvailableSeats(0);
        when(batchDao.findByBatchCode(1L)).thenReturn(batch);

        assertThrows(ResourceNotFoundException.class,
                () -> userService.registerUser(registerDto));
    }

    // -----------------------------------------------------------------------------------------
    // TASKS
    // -----------------------------------------------------------------------------------------
    @Test
    void testGetTasks_Success() {
        when(taskDao.findByUserId(1L)).thenReturn(List.of(task));

        List<Task> list = userService.getTasks(1L);

        assertEquals(1, list.size());
    }

    @Test
    void testGetTasks_NotFound() {
        when(taskDao.findByUserId(1L)).thenReturn(Collections.emptyList());

        assertThrows(ResourceNotFoundException.class,
                () -> userService.getTasks(1L));
    }

    // -----------------------------------------------------------------------------------------
    // PERFORMANCE
    // -----------------------------------------------------------------------------------------
    @Test
    void testGetPerformance_Success() {

        when(performanceDao.findByUserId(1L)).thenReturn(List.of(performance));

        List<Performance> list = userService.getPerformance(1L);

        assertEquals(1, list.size());
    }

    @Test
    void testGetPerformance_NotFound() {

        when(performanceDao.findByUserId(1L)).thenReturn(Collections.emptyList());

        assertThrows(ResourceNotFoundException.class,
                () -> userService.getPerformance(1L));
    }

    // -----------------------------------------------------------------------------------------
    // STIPEND
    // -----------------------------------------------------------------------------------------
    @Test
    void testGetStipendHistory_Success() {

        when(stipendDao.findByUserId(1L)).thenReturn(List.of(stipend));

        List<Stipend> list = userService.getStipendHistory(1L);

        assertEquals(1, list.size());
    }

    @Test
    void testGetStipendHistory_NotFound() {

        when(stipendDao.findByUserId(1L)).thenReturn(Collections.emptyList());

        assertThrows(ResourceNotFoundException.class,
                () -> userService.getStipendHistory(1L));
    }

    // -----------------------------------------------------------------------------------------
    // BATCH
    // -----------------------------------------------------------------------------------------
    @Test
    void testGetBatchDetails_Success() {

        when(batchDao.findById(1L)).thenReturn(batch);

        InternshipBatch result = userService.getBatchDetails(1L);

        assertEquals(1L, result.getBatchCode());
    }

    @Test
    void testGetBatchDetails_NotFound() {

        when(batchDao.findById(1L)).thenReturn(null);

        assertThrows(ResourceNotFoundException.class,
                () -> userService.getBatchDetails(1L));
    }

    // -----------------------------------------------------------------------------------------
    // FEEDBACK
    // -----------------------------------------------------------------------------------------
    @Test
    void testSubmitFeedback_Success() {

        FeedbackDto dto = new FeedbackDto(1L, "Sravya", 1L,
                "Trainer A", "Very good", 5);

        Feedback fb = new Feedback(1L, 1L, "Sravya", 1L,
                "Trainer A", new Timestamp(System.currentTimeMillis()),
                "Very good", 5);

        when(feedbackDao.save(any())).thenReturn(fb);

        Feedback saved = userService.submitFeedback(dto);

        assertNotNull(saved);
        assertEquals("Very good", saved.getFeedback());
    }

    // -----------------------------------------------------------------------------------------
    // ATTENDANCE
    // -----------------------------------------------------------------------------------------
    @Test
    void testGetAttendance_Success() {

        when(attendanceDao.findByUserId(1L)).thenReturn(List.of(attendance));

        List<Attendance> list = userService.getAttendance(1L);

        assertEquals(1, list.size());
    }

    @Test
    void testGetAttendance_NotFound() {

        when(attendanceDao.findByUserId(1L)).thenReturn(Collections.emptyList());

        assertThrows(ResourceNotFoundException.class,
                () -> userService.getAttendance(1L));
    }

    // -----------------------------------------------------------------------------------------
    // PARAMETERIZED TEST
    // -----------------------------------------------------------------------------------------
    @ParameterizedTest
    @ValueSource(strings = {"Sravya", "Kavya", "Navya"})
    void testParameterizedUserNames(String name) {
        User u = new User();
        u.setUserName(name);

        assertNotNull(u.getUserName());
        assertTrue(u.getUserName().length() >= 3);
    }

    // -----------------------------------------------------------------------------------------
    // DISABLED TEST
    // -----------------------------------------------------------------------------------------
    @Disabled("Example disabled test")
    @Test
    void testDisabledExample() {
        fail("This test is disabled.");
    }
}
