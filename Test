package com.finalproject.internMgmtSystem.integration;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.finalproject.internMgmtSystem.dto.FeedbackDto;
import com.finalproject.internMgmtSystem.dto.RegisterUserDto;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;

import java.sql.Date;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@SpringBootTest
@AutoConfigureMockMvc(addFilters = false)

class UserControllerIntegrationTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private ObjectMapper mapper;

    @Test
    void registerUser_Success() throws Exception {
        RegisterUserDto dto = new RegisterUserDto(
        		 "User1", "u@mail.com", "123",
                 Date.valueOf("2000-01-01"), "123", "Hyd", "College", "A",
                 "CSE", "TeamA", 11L,
                 Date.valueOf("2025-01-01"), Date.valueOf("2025-12-01"),
                 2025, "resume.pdf"
        );

        mockMvc.perform(post("/api/user/register")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(mapper.writeValueAsString(dto)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.userId").exists());
    }

    @Test
    void registerUser_Failure_EmailExists() throws Exception {
        RegisterUserDto dto = new RegisterUserDto(
                "Sravya", "sravya@user.com", "123",
                Date.valueOf("2000-01-01"), "9994542", "Chennai",
                "VelTech", "A", "CSE", "Backend", 1L,
                Date.valueOf("2025-01-01"), Date.valueOf("2025-03-01"),
                2025, "resume.pdf"
        );

        mockMvc.perform(post("/api/user/register")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(mapper.writeValueAsString(dto)))
                .andExpect(status().isNotFound());
    }

    @Test
    void getTasks_Success() throws Exception {
        mockMvc.perform(get("/api/user/1/tasks"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.size()").value(1));
    }

    @Test
    void getTasks_NotFound() throws Exception {
        mockMvc.perform(get("/api/users/999/tasks"))
                .andExpect(status().isNotFound());
    }

    @Test
    void getPerformance_Success() throws Exception {
        mockMvc.perform(get("/api/user/1/performance"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.size()").value(1));
    }

    @Test
    void getPerformance_NotFound() throws Exception {
        mockMvc.perform(get("/api/user/999/performance"))
                .andExpect(status().isNotFound());
    }

    @Test
    void getStipends_Success() throws Exception {
        mockMvc.perform(get("/api/user/1/stipends"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.size()").value(1));
    }

    @Test
    void getStipends_NotFound() throws Exception {
        mockMvc.perform(get("/api/user/999/stipends"))
                .andExpect(status().isNotFound());
    }

    @Test
    void getBatchDetails_Success() throws Exception {
        mockMvc.perform(get("/api/user/batch/1001"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.batchCode").value(1001));
    }

    @Test
    void getBatchDetails_NotFound() throws Exception {
        mockMvc.perform(get("/api/user/batch/9999"))
                .andExpect(status().isNotFound());
    }

    @Test
    void submitFeedback_Success() throws Exception {
        FeedbackDto dto = new FeedbackDto();
        dto.setUserId(1L);
        dto.setUserName("Sravya");
        dto.setBatchCode(1001L);
        dto.setTrainerId(1L);
        dto.setTrainerName("John Miller");
        dto.setFeedback("Good");
        dto.setRating(5);

        mockMvc.perform(post("/api/user/feedback")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(mapper.writeValueAsString(dto)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.id").exists());
    }


    @Test
    void submitFeedback_Failure() throws Exception {
        
        FeedbackDto dto = new FeedbackDto();
        dto.setUserId(11L);
        dto.setUserName("User");
        dto.setBatchCode(1001L);
        dto.setTrainerId(1L);
        dto.setTrainerName("John");
        dto.setFeedback("Bad");
        dto.setRating(2);

        mockMvc.perform(post("/api/user/feedback")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(mapper.writeValueAsString(dto)))
                .andExpect(status().isNotFound());
    }

    @Test
    void getAttendance_Success() throws Exception {
        mockMvc.perform(get("/api/user/1/attendance"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.size()").value(1));
    }

    @Test
    void getAttendance_NotFound() throws Exception {
    	mockMvc.perform(get("/api/user/999/attendance"))
        .andExpect(status().isOk())
        .andExpect(jsonPath("$.size()").value(0));

    }

    @Test
    void getAllBatchesPublic_Success() throws Exception {
        mockMvc.perform(get("/api/user/batches"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.size()").value(1));
    }
}INSERT INTO trainers (trainer_id, name, email, password, contact, experience, skills, bio, role)
VALUES (1, 'John Miller', 'john@trainer.com', 'pass123', '9876543210', '5 Years', 'Java, Spring', 'Senior Trainer', 'TRAINER');

INSERT INTO users (user_id, user_name, email, password, dob, contact_no, address, college_name, grade, major, team, batch_code, start_date, end_date, graduating_year, resume, role)
VALUES(11, 'Sravya', 'sravya@user.com', 'pass123', '2002-05-10', '9876543210', 'Chennai', 'Vel Tech', 'A', 'CSE', 'Backend', 1001, '2025-01-01', '2025-03-01', 2025, 'resume.pdf', 'USER');

INSERT INTO users (user_id, user_name, email, password, role)
VALUES (1, 'Sravya', 'sravya@user.com', '$2a$10$7EqJtq98hPqEX7fNZaFWoOeJvYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYw
', 'USER');
INSERT INTO users (user_id, user_name, email, password, role)
VALUES (99, 'Test Admin', 'existing@admin.com', '$2a$10$Dow1iFhZkYwYwYwYwYwYwOeJvYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYwYw
', 'ADMIN');

INSERT INTO internship_batches (batch_code, batch_name, course_name, trainer_id, start_date, end_date, total_seats, available_seats)
VALUES(1001, 'Java Full Stack', 'Java', 1, '2025-12-01', '2026-03-01', 30, 25);

INSERT INTO tasks (id, user_id, description, trainer_id, status, deadline, upload_file)
VALUES(1, 1, 'Build REST API', 1, 'PENDING', '2025-12-04', 'file.pdf');

INSERT INTO attendance (attendance_id, user_id, batch_code, date, present)
VALUES(1, 1, 1001, '2025-12-03', TRUE);

INSERT INTO performance (id, user_id, trainer_id, batch_code, trainer_name, remarks, task_evaluation_score)
VALUES(1, 1, 1, 1001, 'John Miller', 'Good progress', 90);

INSERT INTO feedback (id, user_id, user_name, batch_code, trainer_id, trainer_name, feedback, rating)
VALUES(1, 1, 'Sravya', 1001, 1, 'John Miller', 'Very helpful trainer', 5);

INSERT INTO stipend (id, user_id, user_name, payment_mode, amount)
VALUES(1, 1, 'Sravya', 'Cash', 3000.00);
--Your integration test uses JdbcTemplate-based DAOs, so H2 must have all the tables they will query/insert/update.

CREATE TABLE trainers (
    trainer_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255),
    email VARCHAR(255),
    password VARCHAR(255),
    contact VARCHAR(50),
    experience VARCHAR(100),
    skills VARCHAR(255),
    profile_pic VARCHAR(500),
    bio VARCHAR(1000),
    role VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE users (
    user_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_name VARCHAR(255),
    email VARCHAR(255),
    password VARCHAR(255),
    dob DATE,
    contact_no VARCHAR(50),
    address VARCHAR(255),
    college_name VARCHAR(255),
    grade VARCHAR(50),
    major VARCHAR(100),
    team VARCHAR(100),
    batch_code BIGINT,
    start_date DATE,
    end_date DATE,
    graduating_year INT,
    resume VARCHAR(500),
    profile_pic VARCHAR(500),
    role VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_bcFOREIGN KEY (batch_code)
        REFERENCES internship_batches(batch_code)
        ON DELETE CASCADE
        ON UPDATE CASCADE
);

CREATE TABLE internship_batches (
    batch_code BIGINT AUTO_INCREMENT PRIMARY KEY,
    batch_name VARCHAR(255),
    course_name VARCHAR(255),
    trainer_id BIGINT,
    start_date DATE,
    end_date DATE,
    total_seats INT,
    available_seats INT,
     CONSTRAINT fk_tid FOREIGN KEY (trainer_id)
        REFERENCES trainers(trainer_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE
);

CREATE TABLE stipend (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT,
    user_name VARCHAR(255),
    payment_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    payment_mode VARCHAR(50),
    amount DOUBLE,CONSTRAINT fk_uid FOREIGN KEY (user_id)
        REFERENCES users(user_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
);

CREATE TABLE tasks (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT,
    description VARCHAR(1000),
    trainer_id BIGINT,
    status VARCHAR(50),
    deadline DATE,
    upload_file VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_tasks_user FOREIGN KEY (user_id)
        REFERENCES users(user_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    CONSTRAINT fk_tasks_trainer FOREIGN KEY (trainer_id)
        REFERENCES trainers(trainer_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE
);


CREATE TABLE feedback (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT,
    user_name VARCHAR(255),
    batch_code BIGINT,
    trainer_id BIGINT,
    trainer_name VARCHAR(255),
    date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    feedback VARCHAR(2000),
    rating INT,
    CONSTRAINT fk_tuser FOREIGN KEY (user_id)
        REFERENCES users(user_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    CONSTRAINT fk_trainer FOREIGN KEY (trainer_id)
        REFERENCES trainers(trainer_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
        CONSTRAINT fk_b FOREIGN KEY (batch_code)
        REFERENCES internship_batches(batch_code)
        ON DELETE CASCADE
        ON UPDATE CASCADE
    
);

CREATE TABLE performance (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT,
    trainer_id BIGINT,
    batch_code BIGINT,
    trainer_name VARCHAR(255),
    remarks VARCHAR(2000),
    task_evaluation_score INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_tuser11 FOREIGN KEY (user_id)
        REFERENCES users(user_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    CONSTRAINT fk_trainer1 FOREIGN KEY (trainer_id)
        REFERENCES trainers(trainer_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
        CONSTRAINT fk_b1 FOREIGN KEY (batch_code)
        REFERENCES internship_batches(batch_code)
        ON DELETE CASCADE
        ON UPDATE CASCADE
);

CREATE TABLE attendance (
    attendance_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT,
    batch_code BIGINT,
    date DATE,
    present BOOLEAN,
    CONSTRAINT fk_tuser2 FOREIGN KEY (user_id)
        REFERENCES users(user_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
  
        CONSTRAINT fk_b2 FOREIGN KEY (batch_code)
        REFERENCES internship_batches(batch_code)
        ON DELETE CASCADE
        ON UPDATE CASCADE
);java.lang.AssertionError: JSON path "$.size()" expected:<1> but was:<0>
	at org.springframework.test.util.AssertionErrors.fail(AssertionErrors.java:59)
	at org.springframework.test.util.AssertionErrors.assertEquals(AssertionErrors.java:122)
	at org.springframework.test.util.JsonPathExpectationsHelper.assertValue(JsonPathExpectationsHelper.java:123)
	at org.springframework.test.web.servlet.result.JsonPathResultMatchers.lambda$value$2(JsonPathResultMatchers.java:111)
	at org.springframework.test.web.servlet.MockMvc$1.andExpect(MockMvc.java:214)
	at com.finalproject.internMgmtSystem.integration.UserControllerIntegrationTest.getTasks_Success(UserControllerIntegrationTest.java:66)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:568)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:727)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:217)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:213)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:138)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:68)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:147)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:127)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:90)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:55)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:102)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:54)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:114)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:95)
	at org.junit.platform.launcher.core.DefaultLauncherSession$DelegatingLauncher.execute(DefaultLauncherSession.java:91)
	at org.junit.platform.launcher.core.SessionPerRequestLauncher.execute(SessionPerRequestLauncher.java:60)
	at org.eclipse.jdt.internal.junit5.runner.JUnit5TestReference.run(JUnit5TestReference.java:98)
	at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:40)
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:529)
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:756)
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:452)
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:210)

