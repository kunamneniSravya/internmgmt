package com.finalproject.internMgmtSystem.service;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

import java.sql.Date;
import java.util.Arrays;
import java.util.List;

import org.junit.jupiter.api.*;
import org.mockito.*;
import org.springframework.security.crypto.password.PasswordEncoder;

import com.finalproject.internMgmtSystem.dto.*;
import com.finalproject.internMgmtSystem.exception.*;
import com.finalproject.internMgmtSystem.model.*;
import com.finalproject.internMgmtSystem.repository.*;
import com.finalproject.internMgmtSystem.util.EmailUtil;

public class AdminServiceTest {

    @Mock
    private TrainerDao trainerDao;

    @Mock
    private UserDao userDao;

    @Mock
    private BatchDao batchDao;

    @Mock
    private StipendDao stipendDao;

    @Mock
    private PasswordEncoder encoder;

    @Mock
    private EmailUtil emailUtil;

    @InjectMocks
    private AdminService adminService;

    private Trainer trainer;
    private User user;
    private InternshipBatch batch;
    private Stipend stipend;

    @BeforeEach
    void setup() {
        MockitoAnnotations.openMocks(this);
        trainer = new Trainer();
        trainer.setTrainerId(1L);
        trainer.setEmail("trainer@mail.com");

        user = new User();
        user.setUserId(1L);
        user.setEmail("abc@mail.com");

        batch = new InternshipBatch();
        batch.setBatchCode(1L);

        stipend = new Stipend();
        stipend.setId(1L);
    }

    @Test
    void testRegisterTrainer_Success() {
        RegisterTrainerDto dto = new RegisterTrainerDto();
        dto.setEmail("trainer@mail.com");
        dto.setPassword("123");
        dto.setName("Trainer");
        dto.setContact("111");
        dto.setExperience("2yrs");
        dto.setSkills("Java");
        dto.setBio("bio");

        when(trainerDao.findByEmail("trainer@mail.com")).thenReturn(null);
        when(encoder.encode("123")).thenReturn("encoded");
        when(trainerDao.save(any())).thenReturn(trainer);

        Trainer saved = adminService.registerTrainer(dto);

        assertNotNull(saved);
        verify(trainerDao).findByEmail("trainer@mail.com");
        verify(trainerDao).save(any());
        verify(emailUtil).sendEmail(anyString(), anyString(), anyString());
    }

    @Test
    void testRegisterTrainer_EmailAlreadyExists() {
        RegisterTrainerDto dto = new RegisterTrainerDto();
        dto.setEmail("trainer@mail.com");

        when(trainerDao.findByEmail("trainer@mail.com")).thenReturn(trainer);

        assertThrows(UserAlreadyExistsException.class,
                () -> adminService.registerTrainer(dto));

        verify(trainerDao).findByEmail("trainer@mail.com");
    }

    @Test
    void testCreateBatch_Success() {
        BatchDto dto = new BatchDto(
                "Batch A", "Java", 1L,
                new Date(System.currentTimeMillis()),
                new Date(System.currentTimeMillis()),
                10, 10);

        when(batchDao.save(any())).thenReturn(batch);

        InternshipBatch saved = adminService.createBatch(dto);

        assertNotNull(saved);
        verify(batchDao).save(any());
    }

    @Test
    void testCreateBatch_Failure() {
        BatchDto dto = new BatchDto(
                "Batch A", "Java", 1L,
                new Date(System.currentTimeMillis()),
                new Date(System.currentTimeMillis()),
                10, 10);

        when(batchDao.save(any())).thenThrow(new RuntimeException("DB error"));

        assertThrows(RuntimeException.class, () -> adminService.createBatch(dto));
        verify(batchDao).save(any());
    }

    @Test
    void testGiveStipend_Success() {
        StipendDto dto = new StipendDto(1L, "User", "BANK", 2000.0);

        when(userDao.findById(1L)).thenReturn(user);
        when(stipendDao.save(any())).thenReturn(stipend);

        Stipend saved = adminService.giveStipend(dto);

        assertNotNull(saved);
        verify(userDao).findById(1L);
        verify(stipendDao).save(any());
    }

    @Test
    void testGiveStipend_UserNotFound() {
        StipendDto dto = new StipendDto(10L, "X", "BANK", 1000.0);

        when(userDao.findById(10L)).thenReturn(null);

        assertThrows(ResourceNotFoundException.class,
                () -> adminService.giveStipend(dto));

        verify(userDao).findById(10L);
    }

    @Test
    void testGetAllUsers() {
        when(userDao.findAll()).thenReturn(Arrays.asList(user));

        List<User> list = adminService.getAllUsers();

        assertEquals(1, list.size());
        verify(userDao).findAll();
    }

    @Test
    void testGetAllUsers_Empty() {
        when(userDao.findAll()).thenReturn(List.of());

        List<User> list = adminService.getAllUsers();

        assertTrue(list.isEmpty());
        verify(userDao).findAll();
    }

    @Test
    void testGetAllTrainers() {
        when(trainerDao.findAll()).thenReturn(Arrays.asList(trainer));

        List<Trainer> list = adminService.getAllTrainers();

        assertEquals(1, list.size());
        verify(trainerDao).findAll();
    }

    @Test
    void testGetAllTrainers_Empty() {
        when(trainerDao.findAll()).thenReturn(List.of());

        List<Trainer> list = adminService.getAllTrainers();

        assertTrue(list.isEmpty());
        verify(trainerDao).findAll();
    }

    @Test
    void testGetAllBatches() {
        when(batchDao
