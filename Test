package com.finalproject.internMgmtSystem.service;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

import java.sql.Date;
import java.util.Arrays;
import java.util.List;

import org.junit.jupiter.api.*;
import org.mockito.*;

import org.springframework.security.crypto.password.PasswordEncoder;

import com.finalproject.internMgmtSystem.dto.*;
import com.finalproject.internMgmtSystem.exception.*;
import com.finalproject.internMgmtSystem.model.*;
import com.finalproject.internMgmtSystem.repository.*;

public class UserServiceTest {

    @Mock
    private UserDao userDao;

    @Mock
    private TaskDao taskDao;

    @Mock
    private PerformanceDao performanceDao;

    @Mock
    private StipendDao stipendDao;

    @Mock
    private BatchDao batchDao;

    @Mock
    private FeedbackDao feedbackDao;

    @Mock
    private AttendanceDao attendanceDao;

    @Mock
    private PasswordEncoder encoder;

    @InjectMocks
    private UserService userService;

    private User user;
    private InternshipBatch batch;
    private Task task;
    private Performance performance;
    private Stipend stipend;
    private Attendance attendance;
    private Feedback feedback;

    @BeforeEach
    void setup() {
        MockitoAnnotations.openMocks(this);

        user = new User();
        user.setUserId(1L);
        user.setEmail("u@mail.com");

        batch = new InternshipBatch();
        batch.setBatchCode(1L);
        batch.setAvailableSeats(10);

        task = new Task();
        performance = new Performance();
        stipend = new Stipend();
        attendance = new Attendance();
        feedback = new Feedback();
    }

    @Test
    void testRegisterUser_Success() {
        RegisterUserDto dto = new RegisterUserDto();
        dto.setUserName("User");
        dto.setEmail("u@mail.com");
        dto.setPassword("pass");
        dto.setDob(new Date(System.currentTimeMillis()));
        dto.setContactNo("1111");
        dto.setAddress("ABC");
        dto.setCollegeName("XYZ");
        dto.setGrade("A");
        dto.setMajor("CSE");
        dto.setTeam("Team1");
        dto.setBatchCode(1L);
        dto.setStartDate(new Date(System.currentTimeMillis()));
        dto.setEndDate(new Date(System.currentTimeMillis()));
        dto.setGraduatingYear(2025);
        dto.setResume("resume.pdf");

        when(userDao.findByEmail("u@mail.com")).thenReturn(null);
        when(batchDao.findByBatchCode(1L)).thenReturn(batch);
        when(encoder.encode("pass")).thenReturn("encoded");
        when(userDao.save(any())).thenReturn(user);

        User saved = userService.registerUser(dto);

        assertNotNull(saved);
        verify(userDao).findByEmail("u@mail.com");
        verify(batchDao).findByBatchCode(1L);
        verify(batchDao).decrementAvailableSeats(1L);
        verify(userDao).save(any());
    }

    @Test
    void testRegisterUser_EmailExists() {
        RegisterUserDto dto = new RegisterUserDto();
        dto.setEmail("u@mail.com");

        when(userDao.findByEmail("u@mail.com")).thenReturn(user);

        assertThrows(UserAlreadyExistsException.class,
                () -> userService.registerUser(dto));

        verify(userDao).findByEmail("u@mail.com");
    }

    @Test
    void testRegisterUser_BatchNotFound() {
        RegisterUserDto dto = new RegisterUserDto();
        dto.setEmail("u@mail.com");
        dto.setBatchCode(10L);

        when(userDao.findByEmail("u@mail.com")).thenReturn(null);
        when(batchDao.findByBatchCode(10L)).thenReturn(null);

        assertThrows(ResourceNotFoundException.class,
                () -> userService.registerUser(dto));

        verify(batchDao).findByBatchCode(10L);
    }

    @Test
    void testRegisterUser_NoAvailableSeats() {
        RegisterUserDto dto = new RegisterUserDto();
        dto.setEmail("u@mail.com");
        dto.setBatchCode(1L);

        batch.setAvailableSeats(0);

        when(userDao.findByEmail("u@mail.com")).thenReturn(null);
        when(batchDao.findByBatchCode(1L)).thenReturn(batch);

        assertThrows(ResourceNotFoundException.class,
                () -> userService.registerUser(dto));

        verify(batchDao).findByBatchCode(1L);
    }

    @Test
    void testGetTasks_Success() {
        when(taskDao.findByUserId(1L)).thenReturn(Arrays.asList(task));

        List<Task> list = userService.getTasks(1L);

        assertEquals(1, list.size());
        verify(taskDao).findByUserId(1L);
    }

    @Test
    void testGetPerformance_Success() {
        when(performanceDao.findByUserId(1L)).thenReturn(Arrays.asList(performance));

        List<Performance> list = userService.getPerformance(1L);

        assertEquals(1, list.size());
        verify(performanceDao).findByUserId(1L);
    }

    @Test
    void testGetStipends_Success() {
        when(stipendDao.findByUserId(1L)).thenReturn(Arrays.asList(stipend));

        List<Stipend> list = userService.getStipendHistory(1L);

        assertEquals(1, list.size());
        verify(stipendDao).findByUserId(1L);
    }

    @Test
    void testGetBatchDetails_Success() {
        when(batchDao.findById(1L)).thenReturn(batch);

        InternshipBatch result = userService.getBatchDetails(1L);

        assertNotNull(result);
        verify(batchDao).findById(1L);
    }

    @Test
    void testGetBatchDetails_NotFound() {
        when(batchDao.findById(1L)).thenReturn(null);

        assertThrows(ResourceNotFoundException.class,
                () -> userService.getBatchDetails(1L));

        verify(batchDao).findById(1L);
    }

    @Test
    void testSubmitFeedback_Success() {
        FeedbackDto dto = new FeedbackDto();
        dto.setUserId(1L);
        dto.setBatchCode(1L);
        dto.setTrainerName("Trainer");
        dto.setUserName("User");
        dto.setRating(5);
        dto.setFeedback("Good");

        when(feedbackDao.save(any())).thenReturn(feedback);

        Feedback saved = userService.submitFeedback(dto);

        assertNotNull(saved);
        verify(feedbackDao).save(any());
    }

    @Test
    void testGetAttendance_Success() {
        when(attendanceDao.findByUserId(1L)).thenReturn(Arrays.asList(attendance));

        List<Attendance> list = userService.getAttendance(1L);

        assertEquals(1, list.size());
        verify(attendanceDao).findByUserId(1L);
    }
}
