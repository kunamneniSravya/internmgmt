package com.finalproject.internMgmtSystem.service;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

import org.junit.jupiter.api.*;
import org.mockito.*;
import org.springframework.security.crypto.password.PasswordEncoder;

import com.finalproject.internMgmtSystem.dto.LoginRequest;
import com.finalproject.internMgmtSystem.exception.ResourceNotFoundException;
import com.finalproject.internMgmtSystem.model.Trainer;
import com.finalproject.internMgmtSystem.model.User;
import com.finalproject.internMgmtSystem.repository.TrainerDao;
import com.finalproject.internMgmtSystem.repository.UserDao;
import com.finalproject.internMgmtSystem.security.JwtUtil;

public class AuthServiceTest {

    @Mock
    private UserDao userDao;

    @Mock
    private TrainerDao trainerDao;

    @Mock
    private PasswordEncoder encoder;

    @Mock
    private JwtUtil jwtUtil;

    @InjectMocks
    private AuthService authService;

    private User user;
    private Trainer trainer;

    @BeforeEach
    void setup() {
        MockitoAnnotations.openMocks(this);

        user = new User();
        user.setUserId(1L);
        user.setEmail("user@mail.com");
        user.setPassword("encodedPass");
        user.setRole("USER");

        trainer = new Trainer();
        trainer.setTrainerId(10L);
        trainer.setEmail("trainer@mail.com");
        trainer.setPassword("encodedTrainer");
        trainer.setRole("TRAINER");
        trainer.setName("TrainerName");
    }

    @Test
    void testLogin_UserSuccess() {
        LoginRequest req = new LoginRequest("user@mail.com", "pass");

        when(userDao.findByEmail("user@mail.com")).thenReturn(user);
        when(trainerDao.findByEmail("user@mail.com")).thenReturn(null);
        when(encoder.matches("pass", "encodedPass")).thenReturn(true);
        when(jwtUtil.generateToken(1L, "user@mail.com", "ROLE_USER")).thenReturn("token123");

        String token = authService.login(req);

        assertEquals("token123", token);
        verify(userDao).findByEmail("user@mail.com");
        verify(encoder).matches("pass", "encodedPass");
        verify(jwtUtil).generateToken(1L, "user@mail.com", "ROLE_USER");
    }

    @Test
    void testLogin_TrainerSuccess() {
        LoginRequest req = new LoginRequest("trainer@mail.com", "pass");

        when(userDao.findByEmail("trainer@mail.com")).thenReturn(null);
        when(trainerDao.findByEmail("trainer@mail.com")).thenReturn(trainer);
        when(encoder.matches("pass", "encodedTrainer")).thenReturn(true);
        when(jwtUtil.generateTrainerToken(10L, "trainer@mail.com", "ROLE_TRAINER", "TrainerName"))
                .thenReturn("trainerToken");

        String token = authService.login(req);

        assertEquals("trainerToken", token);
        verify(trainerDao).findByEmail("trainer@mail.com");
        verify(encoder).matches("pass", "encodedTrainer");
        verify(jwtUtil).generateTrainerToken(10L, "trainer@mail.com", "ROLE_TRAINER", "TrainerName");
    }

    @Test
    void testLogin_AccountNotFound() {
        LoginRequest req = new LoginRequest("no@mail.com", "pass");

        when(userDao.findByEmail("no@mail.com")).thenReturn(null);
        when(trainerDao.findByEmail("no@mail.com")).thenReturn(null);

        assertThrows(ResourceNotFoundException.class, () -> authService.login(req));

        verify(userDao).findByEmail("no@mail.com");
        verify(trainerDao).findByEmail("no@mail.com");
    }

    @Test
    void testLogin_User_InvalidPassword() {
        LoginRequest req = new LoginRequest("user@mail.com", "wrong");

        when(userDao.findByEmail("user@mail.com")).thenReturn(user);
        when(trainerDao.findByEmail("user@mail.com")).thenReturn(null);
        when(encoder.matches("wrong", "encodedPass")).thenReturn(false);

        assertThrows(RuntimeException.class, () -> authService.login(req));

        verify(encoder).matches("wrong", "encodedPass");
    }

    @Test
    void testLogin_Trainer_InvalidPassword() {
        LoginRequest req = new LoginRequest("trainer@mail.com", "wrong");

        when(userDao.findByEmail("trainer@mail.com")).thenReturn(null);
        when(trainerDao.findByEmail("trainer@mail.com")).thenReturn(trainer);
        when(encoder.matches("wrong", "encodedTrainer")).thenReturn(false);

        assertThrows(RuntimeException.class, () -> authService.login(req));

        verify(encoder).matches("wrong", "encodedTrainer");
    }
}
