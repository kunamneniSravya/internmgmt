package com.restapiproject.hotelMgmt;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class HotelMgmtApplicationTests {

	@Test
	void contextLoads() {
	}

}
package com.restapiproject.hotelMgmt.controller;

import static org.mockito.Mockito.*;
import org.mockito.*;
import java.math.BigDecimal;
import java.util.*;
import org.junit.jupiter.api.*;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.setup.MockMvcBuilders;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.restapiproject.hotelMgmt.dto.HotelDto;
import com.restapiproject.hotelMgmt.model.Hotel;
import com.restapiproject.hotelMgmt.service.HotelService;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

public class HotelControllerTest {
	
	//MockMvc - used to simulate HTTP request to the controller without starting a web server
	private MockMvc mockMvc;
	
	@Mock
	private HotelService hotelService;
	
	@InjectMocks
	private HotelController hotelController;
	
	private Hotel hotel1;
	private Hotel hotel2;
	
	//mapper will be used to convert DTO objects into JSON strings for POST/PUT 
	private ObjectMapper objectMapper = new ObjectMapper();
	
	@BeforeEach
	void setUp() {
		MockitoAnnotations.openMocks(this);
		mockMvc = MockMvcBuilders.standaloneSetup(hotelController).build();
		//build a MockMvc instance that registers only the controller
		//standalone setup -> do not want to load spring context, wire only the controller and its dependencies
		
		hotel1 = new Hotel(1L, "Hotel A", "Address A", 10, 5, new BigDecimal("100.0"));
		hotel2 = new Hotel(2L, "Hotel B", "Address B", 20, 10, new BigDecimal("200.0"));
	}
	
	//----REST Endpoints Test
	
	@Test
	void testGetAllHotels() throws Exception {
		when(hotelService.getAllHotels()).thenReturn(Arrays.asList(hotel1,hotel2));
		
		mockMvc.perform(get("/api/hotels"))
			   .andExpect(status().isOk())
			   .andExpect(jsonPath("$.size()").value(2)) //assert JSON array of length 2
			   .andExpect(jsonPath("$[0].name").value("Hotel A"))
			   .andExpect(jsonPath("$[1].name").value("Hotel B"));
		verify(hotelService, times(1)).getAllHotels();
	}
	
	@Test
	void testGetHotelById() throws Exception {
		when(hotelService.getHotelById(1L)).thenReturn(hotel1);
		
		mockMvc.perform(get("/api/hotels/1"))
			   .andExpect(status().isOk())
			   .andExpect(jsonPath("$.name").value("Hotel A"))
			   .andExpect(jsonPath("$.total_rooms").value(10));
		verify(hotelService, times(1)).getHotelById(1L);
	}
	
	//POST request
	@Test
	void testCreateHotel() throws Exception {
		HotelDto dto = new HotelDto(null, "Hotel C","Address C",15,8,new BigDecimal("150.00"));
		Hotel createdHotel = new Hotel(3L,"Hotel C","Address C",15,8,new BigDecimal("150.00"));
		
		when(hotelService.createHotel(any(Hotel.class))).thenReturn(createdHotel);
		
		mockMvc.perform(post("/api/hotels")
			   .contentType(MediaType.APPLICATION_JSON)
			   .content(objectMapper.writeValueAsString(dto)))
			   .andExpect(status().isCreated())
			   .andExpect(jsonPath("$.id").value(3))
			   .andExpect(jsonPath("$.name").value("Hotel C"));
		verify(hotelService, times(1)).createHotel(any(Hotel.class));
	}
	
	//PUT request
	@Test
	void testUpdateHotel() throws Exception {
		HotelDto dto = new HotelDto(null, "Hotel A updated","Address A",12,9,new BigDecimal("120.00"));
		Hotel updatedHotel = new Hotel(1L,"Hotel A updated","Address A",12,9,new BigDecimal("120.00"));
		when(hotelService.updateHotel(eq(1L),any(Hotel.class))).thenReturn(updatedHotel);
		
		mockMvc.perform(put("/api/hotels/1")
			   .contentType(MediaType.APPLICATION_JSON)
			   .content(objectMapper.writeValueAsString(dto)))
			   .andExpect(status().isOk())
			   .andExpect(jsonPath("$.name").value("Hotel A updated"))
			   .andExpect(jsonPath("$.available_rooms").value(9));
		verify(hotelService, times(1)).updateHotel(eq(1L),any(Hotel.class));
	}
	
	@Test
	void testDeleteHotel() throws Exception{
		doNothing().when(hotelService).deleteHotel(1L);
		
		mockMvc.perform(delete("/api/hotels/1"))
				.andExpect(status().isNoContent());
		verify(hotelService, times(1)).deleteHotel(1L);
	}
	package com.restapiproject.hotelMgmt.repository;
 
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.junit.jupiter.api.Assertions.fail;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyInt;
import static org.mockito.ArgumentMatchers.anyLong;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.doAnswer;
import static org.mockito.Mockito.when;

import java.math.BigDecimal;
import java.util.Map;
import java.util.Optional;
import java.util.Arrays;
import java.util.List;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Disabled;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.ValueSource;
import org.mockito.InjectMocks;
import org.mockito.*;
import org.mockito.MockitoAnnotations;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.support.KeyHolder;

import com.restapiproject.hotelMgmt.model.Hotel;
import com.restapiproject.hotelMgmt.util.HotelRowMapper;
 
public class HotelDaoImplTest {

	// mock the jdbc template-unit test - no Db
	//Mockito - java mocking framework
	// allows developers to create and manage mock objects
	// simulate the behaviour of real objects
	// @Mock - jdbc template
	//@InjectMocks - construct the DAO and inject the mock - jdbc Template
	
	@Mock // tell mockito - create a mock instance of JdbcTemplate
	private JdbcTemplate jdbcTemplate;
	
	@InjectMocks//create instance of hotelDaoImpl class and inject mock dependency - jdbc template
	private HotelDaoImpl hotelDao;
	private Hotel hotel1;
	private Hotel hotel2;

	@BeforeEach // run before each test
	void setup() {
		MockitoAnnotations.openMocks(this);// initializing mockito annotations - @Mock,@InjectMocks in the test instance
		hotel1 = new Hotel(1L, "Hotel A", "Address A", 10, 5, new BigDecimal("100.0"));
		hotel2 = new Hotel(2L, "Hotel B", "Address B", 20, 10, new BigDecimal("200.0"));
	}

	// --- basic crud tests ----

	@Test // mark this method as a test
	void testSave() {
		doAnswer(invocation -> {
			KeyHolder keyHolder = invocation.getArgument(1);
			keyHolder.getKeyList().add(Map.of("GENERATED_KEY", 1L));
			return 1;
		}).when(jdbcTemplate).update(any(), any(KeyHolder.class));
		Hotel result = hotelDao.save(hotel1);
		assertNotNull(result); 
		
		// returned object is not null
		// call jdbcTemplate - update - 
		// real jdbc - execute insert - fill the keyholder - with generated pk
		// - getKey() - getting that key - set it on hotel instance
		// doAnswer - intercept the mock call  -tells mockito to run provided lambda function
		// invocation - object representing the intercepted method call
		// getArgument(1) - fetch the second argument
		

	}
	
	@Test
	void testFindById_Found() {
		//                       (String sql, RowMapper, Object......args)
		when (jdbcTemplate.query(anyString(), any(HotelRowMapper.class), eq(1L)))
			.thenReturn(Arrays.asList(hotel1));
		Optional<Hotel> result = hotelDao.findById(1L);
		assertTrue(result.isPresent()); //confirm DAO returned a non empty optional
		assertEquals("Hotel A",result.get().getName());
	}
	
	@Test
	void testFindById_NotFound() {
		
		when(jdbcTemplate.query(anyString(), any(HotelRowMapper.class), eq(3L)))
		    .thenReturn(Arrays.asList(hotel1));
		
		Optional<Hotel> result = hotelDao.findById(31L);
		assertFalse(result.isPresent()); // verify that 3L return Optional.empty()
		                                 // verify  DAO is correctly handling missing row
	}
	
	@Test
	void testFindAll() {
		
		when(jdbcTemplate.query(anyString(), any(HotelRowMapper.class)))
		    .thenReturn(Arrays.asList(hotel1, hotel2));
		
		List<Hotel> result = hotelDao.findAll();		
		assertEquals(2, result.size()); //matching result size - 2 hotels
	}
	
	@Test
	void testUpdate() {
		when (jdbcTemplate.update(anyString(), 
				anyString(),anyString(),anyInt(),anyInt(),any(BigDecimal.class),anyLong()))
				.thenReturn(1); //1 row effected
		int rows = hotelDao.update(hotel1);
		assertEquals(1,rows); 
	}
	
	@Test
	void testDelete() {
		when (jdbcTemplate.update(anyString(), anyLong()))
				.thenReturn(1); //1 row effected
		int rows = hotelDao.deleteById(1L);
		assertEquals(1,rows); 
	}
	
	//-----Parameterized Test----------
	//run method for multiple inputs
	@ParameterizedTest
	@ValueSource(strings = {"Hotel X","Hotel Y","Hotel Z"})
	void testParameterizedHotelNames(String name) {
		Hotel hotel = new Hotel();
		hotel.setName(name);
		assertNotNull(hotel.getName());
		assertTrue(hotel.getName().startsWith("Hotel"));
		//run the test multiple times - values - in ValueSource -3
		//for each name - create a new Hotel, set the name, verify name is not null and start with Hotel
	}
	
	//-------Skip Test----
	@Disabled("Example skipped DAO test")
	@Test
	void testDisableExample() {
		fail("This DAO test is disabled and skipped");
		//test was enables - it would have been failed
		//learning how to skip test
		
	}
	





}

 package com.restapiproject.hotelMgmt.service;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;
 
import java.math.BigDecimal;
import java.util.Arrays;
import java.util.List;
import java.util.Optional;
 
import org.junit.jupiter.api.*;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.ValueSource;
import org.mockito.*;

import com.restapiproject.hotelMgmt.exception.ResourceNotFoundException;
import com.restapiproject.hotelMgmt.model.Hotel;
import com.restapiproject.hotelMgmt.repository.HotelDao;
 

public class HotelServiceImplTest {
	
	@Mock
	private HotelDao hotelDao;
	
	@InjectMocks
	private HotelServiceImpl hotelService;
	
	private Hotel hotel1;
	private Hotel hotel2;
	
	@BeforeEach
	void setup() {
		MockitoAnnotations.openMocks(this);
		hotel1 = new Hotel(1L, "Hotel A", "Address A", 10, 5, new BigDecimal("100.0"));
		hotel2 = new Hotel(2L, "Hotel B", "Address B", 20, 10, new BigDecimal("200.0"));
	}
	
	@Test
	void testCreateHotel() {
		when(hotelDao.save(hotel1)).thenReturn(hotel1);
		Hotel created = hotelService.createHotel(hotel1);
		assertNotNull(created);
		assertEquals("Hotel A", created.getName());
		verify(hotelDao,times(1)).save(hotel1);
	}
	
	@Test
	void testGetHotelById_Found() {
		when(hotelDao.findById(1L)).thenReturn(Optional.of(hotel1));
		Hotel found = hotelService.getHotelById(1L);
		assertNotNull(found);
		assertEquals("Hotel A", found.getName());
		verify(hotelDao,times(1)).findById(1L);
	}
	
	@Test
	void testGetHotelById_NotFound() {
		when(hotelDao.findById(1L)).thenReturn(Optional.empty());
		assertThrows(ResourceNotFoundException.class, () -> hotelService.getHotelById(3L));
		verify(hotelDao,times(1)).findById(3L);
	}
	
	@Test
	void testGetAllHotels() {
		when(hotelDao.findAll()).thenReturn(Arrays.asList(hotel1,hotel2));
		List<Hotel> hotels = hotelService.getAllHotels();
		assertEquals(2, hotels.size());
		verify(hotelDao,times(1)).findAll();
	}
	
	@Test
	void testUpdateHotel_Success() {
		when(hotelDao.findById(1L)).thenReturn(Optional.of(hotel1));
		when(hotelDao.update(any(Hotel.class))).thenReturn(1);
		
		Hotel updateHotel = new Hotel(null, "Hotel A Updated","Address Updated",15,8, new BigDecimal("150.00"));
		Hotel result = hotelService.updateHotel(1L, updateHotel);
		
		assertAll("Update Hotel Properties",
				() -> assertEquals("Hotel A Updated", result.getName()),
				() -> assertEquals("Address Updated",result.getAddress()),
				() -> assertEquals(15, result.getTotal_rooms()),
				() -> assertEquals(8, result.getAvailable_rooms()),
				() -> assertEquals(new BigDecimal("150.00"),result.getPrice_per_night()));
		verify(hotelDao, times(1)).update(any(Hotel.class));
		
	}
	
	@Test
	void testUpdateHotel_Failure() {
		when(hotelDao.findById(1L)).thenReturn(Optional.of(hotel1));
		when(hotelDao.update(any(Hotel.class))).thenReturn(0);
		
		Hotel updateHotel = new Hotel(null, "Hotel A Updated","Address Updated", 15, 8, new BigDecimal("150.00"));
		
		RuntimeException exception = assertThrows(RuntimeException.class, () -> hotelService.updateHotel(1L, updateHotel));
		assertEquals("Update failed for hotel id : 1", exception.getMessage());
		verify(hotelDao, times(1)).update(any(Hotel.class));	
		
	}
	
	@Test
	void testDeleteHotel_Success() {
		when(hotelDao.findById(1L)).thenReturn(Optional.of(hotel1));
		when(hotelDao.deleteById(1L)).thenReturn(1);
		
		assertDoesNotThrow( () -> hotelService.deleteHotel(1L));
		verify(hotelDao, times(1)).deleteById(1L);
	}
	
	@Test
	void testDeleteHotel_Failure() {
		when(hotelDao.findById(1L)).thenReturn(Optional.of(hotel1));
		when(hotelDao.deleteById(1L)).thenReturn(0);
		
		RuntimeException exception = assertThrows(RuntimeException.class, () -> hotelService.deleteHotel(1L));
		assertEquals("Delete failed for hotel id : 1", exception.getMessage());
		verify(hotelDao, times(1)).deleteById(1L);
	}
	
	@ParameterizedTest
	@ValueSource(strings = {"Hotel A", "Hotel B","Hotel c"})
	void testParameterizedHotelNames(String name) {
		Hotel hotel = new Hotel();
		hotel.setName(name);
		assertNotNull(hotel.getName());
		assertTrue(hotel.getName().startsWith("Hotel"));
	}

}


}
